
function tp_delegate(element, eventType, className, handler) {
	console.log(className);
	element.addEventListener(eventType, (e) => {
		if (!e.target.classList.contains(className)) {
			return false
		}
		handler(e)
	})
}

function tp_scroll_to(element) {
	let header = document.querySelector('body > header');
	let to = element.offsetTop;
	let node = element;

	// Перебираем до последнего родительского элемента для подсчёта Y-координаты element
	while (node.offsetParent && node.offsetParent != document.body) {
		node = node.offsetParent;
		to += node.offsetTop;
	}

	// Небольшой отступ
	to -= 20;

	// Если есть header, то вычитаем его положение из Y-координаты element
	if (header) {
		to -= header.offsetHeight;
	}

	window.scrollTo({
		top: to,
		behavior: 'smooth'
	});
}

/**
 * Функция деактивации полей формы
 * @param {*} form 
 */
function tp_form_disabled(form) {
	const inputs = form.querySelectorAll('input');
	if (inputs.length) {
		for (let i = 0; i < inputs.length; i++) {
			const element = inputs[i];
			if (element.getAttribute('type') == 'radio' || element.getAttribute('type') == 'checkbox') {
				element.setAttribute('disabled', '');
			} else {
				element.setAttribute('readonly', '');
			}
		}
	}

	const selects = form.querySelectorAll('select');
	if (selects.length) {
		for (let i = 0; i < selects.length; i++) {
			const element = selects[i];
			element.setAttribute('disabled', '');
		}
	}
}

function tp_do_ajax(request) {
	var xhr = new XMLHttpRequest();

	if (request.method == "GET") {
		request.url += '?' + request.data;
		request.data = null;
	}
	xhr.open(request.method, request.url);

	if (typeof request.data != 'object') {
		xhr.setRequestHeader('Content-Type', request.contentType);
	}

	if (request.dataType != null) {
		xhr.setRequestHeader('Data-Type', request.contentType);
	}

	xhr.onerror = function () {
		console.warn('ajax request error');
	}

	xhr.onprogress = function (event) {
		if (event.lengthComputable) {
			console.log(`Получено ${event.loaded} из ${event.total} байт`);
		} else {
			console.log(`Получено ${event.loaded} байт`); // если в ответе нет заголовка Content-Length
		}

	};

	xhr.onreadystatechange = function () {
		if (xhr.readyState == 3) {
			// console.log(xhr.response);
		}

		if (xhr.readyState == 4) {
			if (xhr.status == 200) {
				request.success(xhr.response);
			} else {
				console.warn(`Ошибка ${xhr.status}: ${xhr.statusText}`);
			}
		}
	}

	xhr.send(request.data);
}

function tp_submit_form_ajax(e) {
	const form = e.target;
	const wrapper = form.parentElement;
	const form_id = form.id;
	let form_data = new FormData(form);
	let informer = tp_set_informer_by_form(wrapper, form, form_id.replace('get-', ''));

	console.log('submit');

	let success = true;

	if (success) {
		let btn_submit = form.querySelector('button[type="submit"]');
		btn_submit.setAttribute('disabled', 'disable');
		wrapper.classList.add('loader-bar');

		tp_do_ajax({
			method: 'POST',
			url: window.wp_theplugin.ajax_url,
			data: form_data,
			contentType: 'application/x-www-form-urlencoded',
			success: function (data) {
				wrapper.classList.remove('loader-bar');
				console.log('success');
				console.log(data);
				data = JSON.parse(data);


				if (data.message != null && data.type != null) {
					switch (data.type) {
						case 'ok':
							form.remove();
							break;
						case 'error':
							break;
						case 'fail':
						case 'spam':
							form.remove();
							break;
						default: ;
					}
					informer.innerHTML = data.message;
				} else {
					tp_get_form_notice_error(informer);
				}

			}
		});
	}
}

function tp_get_form_notice_error(informer) {
	informer.innerHTML = window.wp_theplugin.notice_error;
}

function tp_set_informer_by_form(wrapper = null, block = null, form_id = '') {
	if (form_id == '' || wrapper == null || block == null) {
		return '';
	}

	if (!document.querySelector('.informer[data-id="get-' + form_id + '"]')) {
		console.log('no informer');
		let informer_block = document.createElement('div');
		informer_block.setAttribute('data-id', 'get-' + form_id);
		informer_block.classList.add('informer');
		wrapper.insertBefore(informer_block, block);
	}

	let informer = document.querySelector('.informer[data-id="get-' + form_id + '"]');
	informer.innerHTML = '';

	return informer;
}

function tp_get_form_ajax(block, form_args = {}) {

	// const block = e.target;
	const form_id = block.getAttribute('data-form-ajax');
	const wrapper = block.parentElement;

	// Определяем наличие дополнительных переменных для запроса 
	/*
	let form_args = Array();
	if (block.getAttribute('data-form-args')) {
		form_args = JSON.parse(block.getAttribute('data-form-args'));
		console.log(form_args);
	}
	*/

	wrapper.classList.add('loader-bar');

	let informer = tp_set_informer_by_form(wrapper, block, form_id);
	console.log(informer);

	if (document.querySelector('form[id="get-' + form_id + '"]')) {
		let form_remove = document.querySelector('form[id="get-' + form_id + '"]');
		form_remove.remove();
	}

	if (!document.querySelector('form[id="get-' + form_id + '"]')) {

		let form_data = new FormData();
		form_data.append('action', 'theplugin_getform');
		form_data.append('get-form', form_id);

		for (var key in form_args) {
			console.log(key + ' = ' + form_args[key]);
			form_data.append(key, form_args[key]);
		}

		tp_do_ajax({
			method: 'POST',
			url: window.wp_theplugin.ajax_url,
			// data: 'action=theplugin_getform&get-form=' + form_id,
			data: form_data,
			contentType: 'application/x-www-form-urlencoded',
			success: function (data) {

				wrapper.classList.remove('loader-bar');

				data = JSON.parse(data);
				console.log('success');
				console.log(data);

				if (data.message != null && data.type != null) {
					switch (data.type) {
						case 'ok':
							wrapper.insertAdjacentHTML('beforeend', data.message);
							tp_set_masked_phone(wrapper);
							block.remove();
							break;
						case 'fail':
						case 'error':
							informer.innerHTML = data.message;
							break;
						default: ;
					}
				} else {
					tp_get_form_notice_error(informer);
				}
			}
		});
	} else {
		wrapper.classList.remove('loader-bar');
	}
}

/**
 * MaskedInput
 */
function setCursorPosition(pos, elem) {
	elem.focus();
	if (elem.setSelectionRange) elem.setSelectionRange(pos, pos);
	else if (elem.createTextRange) {
		var range = elem.createTextRange();
		range.collapse(true);
		range.moveEnd("character", pos);
		range.moveStart("character", pos);
		range.select()
	}
}

function mask(event, matrix = '+7 (___) ___-____') {
	// var matrix = this.defaultValue,
	i = 0,
		def = matrix.replace(/\D/g, ""),
		val = this.value.replace(/\D/g, "");
	def.length >= val.length && (val = def);
	matrix = matrix.replace(/[_\d]/g, function (a) {
		return val.charAt(i++) || "_"
	});
	this.value = matrix;
	i = matrix.lastIndexOf(val.substr(-1));
	i < matrix.length && matrix != this.defaultValue ? i++ : i = matrix.indexOf("_");
	setCursorPosition(i, this)
}

function tp_set_masked_phone(wrapper) {
	const input_phones = wrapper.querySelectorAll('input.mask-phone');
	if (input_phones.length) {
		for (let i = 0; i < input_phones.length; i++) {
			const input_phone = input_phones[i];
			input_phone.addEventListener('input', mask, false);
		}
	}
}

window.addEventListener("DOMContentLoaded", function () {
	tp_set_masked_phone(document);
});
/**
 * Popup wrapper
 */
function tp_set_popup_wrapper(popup_id = '', form_ajax = false) {
	if (popup_id == '' || popup_id == undefined)
		return '';

	if (!document.getElementById('theplugin-popup-' + popup_id)) {
		let popup_body = document.createElement('div');
		popup_body.setAttribute('id', 'theplugin-popup-' + popup_id);
		popup_body.classList.add('thetheme-popup', 'close');
		popup_body.innerHTML = '<div class="thetheme-popup__wrapper"><div class="thetheme-popup__content"><a class="thetheme-popup-btn__close" href="#' + popup_id + '"></a></div></div>';

		document.body.append(popup_body);
	}

	if (document.getElementById('theplugin-popup-' + popup_id)) {
		if (form_ajax) {
			let popup_body = document.getElementById('theplugin-popup-' + popup_id);
			if (!popup_body.querySelector('.theplugin-form-ajax')) {
				let popup_ajax = document.createElement('div');
				popup_ajax.setAttribute('data-form-ajax', popup_id);
				popup_ajax.classList.add('theplugin-form-ajax');
				popup_body.querySelector('.thetheme-popup__content').append(popup_ajax);
			}
		}
		return popup_id;
	}

	return '';
}
function tp_popup_close(popup_id = '') {
	if (popup_id == '' || popup_id == undefined)
		return '';

	console.log('close ' + popup_id);

	let popup_body = document.getElementById('theplugin-popup-' + popup_id);
	popup_body.classList.add('close');
	document.body.classList.remove('unscroll');
}

function tp_popup_open(popup_id = '') {
	if (popup_id == '' || popup_id == undefined)
		return '';

	let popup_body = document.getElementById('theplugin-popup-' + popup_id);
	popup_body.classList.remove('close');
	document.body.classList.add('unscroll');
}
/**
 * Open/close popup
 */
function tp_set_popup_toggle(e) {
	const target = e.target;
	let popup_id = target.getAttribute('href');
	// Проверяем наличие ссылки
	if (popup_id) {
		popup_id = popup_id.replace('#', '');
		let form_ajax = false;
		if (target.classList.contains('tp-form-ajax')) {
			form_ajax = true;
		}
		// Задаём объект всплывающего окна
		let popup_body = tp_set_popup_wrapper(popup_id, form_ajax);

		// Если объекта окна есть
		if (popup_body == popup_id) {
			popup_body = document.getElementById('theplugin-popup-' + popup_id);

			if (popup_body.classList.contains('close')) {
				if (document.querySelector('.theplugin-form-ajax[data-form-ajax="' + popup_id + '"]')) {
					console.log('popup-ajax');
					console.log(popup_id);
					let block = document.querySelector('.theplugin-form-ajax[data-form-ajax="' + popup_id + '"]');

					let form_args = {};
					if (target.getAttribute('data-form-args')) {
						form_args = JSON.parse(target.getAttribute('data-form-args'));
					}
					tp_get_form_ajax(block, form_args);
				}
				tp_popup_open(popup_id);
			} else {
				tp_popup_close(popup_id);
			}
		}
	}
}

function tp_close_popup_active(e) {
	const popup_list = document.querySelectorAll('.thetheme-popup:not(.close)');
	if (popup_list.length) {
		for (let i = 0; i < popup_list.length; i++) {
			if (!e.target.closest('.thetheme-popup__content')) {
				let popup_content = popup_list[i].querySelector('.thetheme-popup__content');
				let popup_link = popup_content.querySelector('.thetheme-popup-btn__close');
				let popup_id = popup_link.getAttribute('href').replace('#', '');
				tp_popup_close(popup_id);
			}
		}
	}
}
/**
 * Popup margin top
 */
/*
$.fn.tt_set_popup_margin = function () {
	var $popup = $(this);
	if (!$popup.hasClass('close')) {
		var $block = $popup.children('div.block');
		if ($block.outerHeight() > $(window).height()) {
			$block.css({ 'margin-top': $block.outerHeight() - $(window).height() + $('header').height() + 100 + 'px' });
		} else {
			$block.css({ 'margin-top': '80px' });
		}
	}
}
*/

// $(window).resize(function () { $('.theplugin-popup:not(.close)').tt_set_popup_margin(); }); 
document.addEventListener('DOMContentLoaded', function (e) {
	const popup_links = document.querySelectorAll('a[href^="#tp-popup-"]:not(.tp-popup-link)');
	if (popup_links.length) {
		for (let i = 0; i < popup_links.length; i++) {
			const popup_btn = popup_links[i];
			const popup_id = popup_btn.getAttribute('href').replace('#tp-popup-', '');
			popup_btn.setAttribute('href', '#' + popup_id);
			popup_btn.classList.add('tp-popup-link', 'tp-form-ajax');

			console.log(popup_id);
			if (popup_btn.parentElement.classList.contains('menu-item')) {
				popup_btn.classList.add('button', 'primary', 'full');
			}
			/*
			switch (popup_id) {
				case 'recall':
					
					break;
				default:
					break;
			}
			*/
		}
	}

	/**
	 * POPUP TOOGLE
	 */
	tp_delegate(document.body, 'click', 'tp-popup-link', function (e) {
		e.preventDefault();
		tp_set_popup_toggle(e);
	});

	tp_delegate(document.body, 'click', 'thetheme-popup-btn__close', function (e) {
		e.preventDefault();

		const target = e.target;
		let popup_id = target.getAttribute('href').replace('#', '');
		if (popup_id) {
			tp_popup_close(popup_id);
		}
	});

	/**
	   * События при отпускании клика мыши
	   */
	document.addEventListener('mouseup', function (e) {
		/**
		 * Проверка на открытые модальная окна
		 */
		tp_close_popup_active(e);
	});

	/**
	   * События при нажатии на Esc
	   */
	document.addEventListener('keydown', function (e) {
		if (e.which === 27) {
			/**
			  * Проверка на открытые модальная окна
			  */
			tp_close_popup_active(e);
		}
	});

	tp_delegate(document.body, 'submit', 'tp-form-ajax', function (e) {
		e.preventDefault();
		tp_submit_form_ajax(e);
	});

	/*
	tp_do_ajax({
		method: 'POST',
		url: '/templates/form-trip.php',
		data: '',
		contentType: 'application/x-www-form-urlencoded',
		success: function (data) {
			console.log('success');
			console.log(data);
		}
	});
	*/

	const gallery_grid = document.querySelectorAll('.wp-block-gallery.gallery-grid-column');
	if (gallery_grid.length) {
		for (let i = 0; i < gallery_grid.length; i++) {
			const gallery_item = gallery_grid[i];
			//const popup_id = popup_btn.getAttribute('href').replace('#tp-popup-', '');
		}
	}
});